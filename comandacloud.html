<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Brasas POS v6.2 - Men√∫ Oficial</title>
    
    <!-- Librer√≠a QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- FIREBASE (Compat Version - Funciona directo en HTML) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* ESTILOS BASE */
        :root { --primary: #d32f2f; --bg: #f4f6f9; --dark-bg: #121212; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding-bottom: 50px; }
        
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        
        /* TARJETAS */
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        
        .mesa { height: 100px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; cursor: pointer; position: relative; transition: 0.2s; }
        .mesa:hover { transform: scale(1.03); }
        .mesa.libre { background: #4caf50; }
        .mesa.ocupada { background: #d32f2f; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* BOTONES */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #2e7d32; }
        .btn-warning { background: #ff9800; color: #333; }
        .btn-info { background: #17a2b8; }
        
        /* NAVEGACI√ìN */
        .tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .tab { padding: 10px 15px; border: none; background: white; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 600; color: #555; }
        .tab.active { background: var(--primary); color: white; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        
        /* UI COCINA */
        .ticket-cocina { border-left: 6px solid #ccc; }
        .ticket-cocina.pendiente { border-color: #ff9800; background: #fff3e0; }
        .ticket-cocina.listo { border-color: #2e7d32; background: #e8f5e9; }
        .timer-badge { font-family: monospace; font-weight: bold; float: right; }
    </style>
</head>
<body>

    <!-- INSTALADOR (Aparece si la BD est√° vac√≠a) -->
    <div id="installer" class="modal">
        <div class="modal-content">
            <h1 style="font-size: 3em;">üöÄ</h1>
            <h2>Conectado a Firebase</h2>
            <p>Se detect√≥ una base de datos nueva.</p>
            <button class="btn btn-primary" onclick="instalarBD()">üõ†Ô∏è INSTALAR BASE DE DATOS</button>
        </div>
    </div>

    <!-- MODAL QR -->
    <div id="qrModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Escanea Mesa <span id="qrMesaNum"></span></h3>
            <div id="qrcode" style="margin:20px auto; display:flex; justify-content:center"></div>
            <p style="font-size:0.8em; color:#666;">Comparte este c√≥digo para que el cliente pida desde su celular.</p>
            <button class="btn btn-warning" onclick="this.parentElement.parentElement.style.display='none'">Cerrar</button>
        </div>
    </div>

    <div class="container">
        <!-- HEADER -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; flex-wrap: wrap; gap: 10px;">
            <div>
                <h2 style="color:var(--primary); margin:0;">üî• Las Brasas</h2>
                <small style="color:green; font-weight:bold;">‚óè Nube Activa</small>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info" style="width: auto; padding: 8px; margin: 0; font-size: 0.8em;" onclick="actualizarMenuCompleto()">üîÑ Actualizar Men√∫</button>
                <select id="rolSelect" onchange="cambiarRol()" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
                    <option value="mesero">Rol: Mesero</option>
                    <option value="cocina">Rol: Cocina</option>
                    <option value="cliente">Rol: Cliente (Simulado)</option>
                </select>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs" id="navTabs">
            <button class="tab active" onclick="verTab('mesas')">üìç Mesas</button>
            <button class="tab" onclick="verTab('comanda')">üìù Comanda</button>
            <button class="tab" onclick="verTab('cocina')">üî• Cocina Live</button>
        </div>

        <!-- VISTA MESAS -->
        <div id="view-mesas">
            <div class="grid" id="gridMesas">
                <p style="text-align:center; width:100%;">Cargando mesas desde Firebase...</p>
            </div>
        </div>

        <!-- VISTA COMANDA -->
        <div id="view-comanda" class="hidden">
            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <!-- Carrito -->
                <div class="card" style="border: 2px solid var(--primary);">
                    <h3 style="display:flex; justify-content:space-between;">
                        Mesa <span id="mesaTitle">--</span>
                        <span id="cartTotal" style="color:var(--primary); font-size:1.2em;">$0.00</span>
                    </h3>
                    <div id="cartItems" style="margin:10px 0; max-height:200px; overflow-y:auto; font-size:0.9em;">
                        <p style="color:#999; text-align:center;">Carrito vac√≠o</p>
                    </div>
                    <button class="btn btn-success" onclick="enviarPedido()">‚úÖ ENVIAR PEDIDO A COCINA</button>
                </div>
                
                <!-- Men√∫ -->
                <div>
                    <h3>Men√∫</h3>
                    <!-- Filtro simple -->
                    <input type="text" id="menuSearch" placeholder="üîç Buscar taco, gringa..." onkeyup="filtrarMenu()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px;">
                    <div class="grid" id="gridMenu">Cargando men√∫...</div>
                </div>
            </div>
        </div>

        <!-- VISTA COCINA -->
        <div id="view-cocina" class="hidden">
            <div id="cocinaList">Esperando √≥rdenes en tiempo real...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // üî¥ CONFIGURACI√ìN DE FIREBASE ACTUALIZADA üî¥
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB6LwVZmFSNVXvJgLF9nHy1Y3bkramhuEA",
            authDomain: "lasbrasaspos.firebaseapp.com",
            projectId: "lasbrasaspos",
            storageBucket: "lasbrasaspos.firebasestorage.app",
            messagingSenderId: "924369313118",
            appId: "1:924369313118:web:f124d313b1420f8dd983cf",
            measurementId: "G-LJC0KQJHEJ"
        };

        // INICIALIZAR FIREBASE
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // VARIABLES GLOBALES
        let currentMesa = null;
        let carrito = [];
        let modoCliente = false;
        let menuCache = []; // Para b√∫squeda r√°pida local

        // --- CORE: ESCUCHADORES EN TIEMPO REAL (MAGIC) ---

        // 1. Escuchar MESAS
        db.collection("mesas").orderBy("id").onSnapshot((snapshot) => {
            const el = document.getElementById("gridMesas");
            
            if(snapshot.empty) {
                document.getElementById("installer").style.display = 'flex';
                el.innerHTML = "<p>Base de datos vac√≠a.</p>";
                return;
            } else {
                document.getElementById("installer").style.display = 'none';
            }

            el.innerHTML = "";
            snapshot.forEach((doc) => {
                const m = doc.data();
                const div = document.createElement("div");
                div.className = `mesa ${m.estado}`;
                div.innerHTML = `
                    <span style="font-size:2em">${m.id}</span>
                    <small>${m.estado.toUpperCase()}</small>
                    ${!modoCliente ? `<span style="position:absolute; bottom:5px; right:5px; font-size:1.2em;">üì±</span>` : ''}
                `;
                div.onclick = () => {
                    if(!modoCliente) showQR(m.id);
                    abrirMesa(m.id); 
                };
                el.appendChild(div);
            });
        });

        // 2. Escuchar MEN√ö
        db.collection("menu").orderBy("nombre").onSnapshot((snapshot) => {
            menuCache = [];
            snapshot.forEach(doc => menuCache.push(doc.data()));
            renderMenuGrid(menuCache);
        });

        function renderMenuGrid(items) {
            const el = document.getElementById("gridMenu");
            el.innerHTML = "";
            items.forEach((p) => {
                const btn = document.createElement("div");
                btn.className = "card";
                btn.style.cursor = "pointer";
                // Color distintivo por categor√≠a
                let borderCol = "#ddd";
                if(p.categoria === 'Tacos') borderCol = "#d32f2f"; // Rojo
                if(p.categoria === 'Bebidas') borderCol = "#1976d2"; // Azul
                if(p.categoria === 'Especiales') borderCol = "#fbc02d"; // Amarillo
                
                btn.style.borderLeft = `4px solid ${borderCol}`;
                btn.innerHTML = `<b>${p.nombre}</b><br><span style="color:var(--primary)">$${p.precio}</span><br><small style="color:#666">${p.categoria || ''}</small>`;
                btn.onclick = () => agregarAlCarrito(p);
                el.appendChild(btn);
            });
        }

        function filtrarMenu() {
            const term = document.getElementById("menuSearch").value.toLowerCase();
            const filtered = menuCache.filter(p => p.nombre.toLowerCase().includes(term) || (p.categoria && p.categoria.toLowerCase().includes(term)));
            renderMenuGrid(filtered);
        }

        // 3. Escuchar COMANDAS (Cocina)
        db.collection("comandas")
          .where("estado", "!=", "cerrado")
          .onSnapshot((snapshot) => {
            const el = document.getElementById("cocinaList");
            el.innerHTML = "";
            if(snapshot.empty) el.innerHTML = "<p style='text-align:center; margin-top:50px;'>Todo limpio, Chef üë®‚Äçüç≥</p>";
            
            let docs = [];
            snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
            // Ordenar en cliente para evitar requerir √≠ndice complejo ahora
            docs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            docs.forEach((c) => {
                const card = document.createElement("div");
                card.className = `card ticket-cocina ${c.estado}`;
                
                let tiempo = "Ahora";
                if(c.timestamp) {
                    const diff = Math.floor((Date.now() - c.timestamp.toDate()) / 1000 / 60);
                    tiempo = `${diff} min`;
                }

                let btnAccion = "";
                if(c.estado === 'pendiente') btnAccion = `<button class="btn btn-primary" onclick="cambiarEstado('${c.id}', 'listo')">üî• A Fuego</button>`;
                if(c.estado === 'listo') btnAccion = `<button class="btn btn-success" onclick="cambiarEstado('${c.id}', 'cerrado')">‚úÖ Entregar y Cerrar</button>`;

                card.innerHTML = `
                    <h3>Mesa ${c.mesaId} <span class="timer-badge">${tiempo}</span></h3>
                    <small>Estado: ${c.estado.toUpperCase()}</small>
                    <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                    <ul style="padding-left:20px; margin:10px 0;">
                        ${c.items.map(i => `<li>${i.nombre}</li>`).join('')}
                    </ul>
                    ${btnAccion}
                `;
                el.appendChild(card);
            });
        });

        // --- L√ìGICA DE NEGOCIO ---

        function abrirMesa(id) {
            currentMesa = id;
            document.getElementById("mesaTitle").innerText = id;
            carrito = [];
            renderCarrito();
            verTab('comanda');
        }

        function agregarAlCarrito(prod) {
            carrito.push(prod);
            renderCarrito();
        }

        function renderCarrito() {
            const el = document.getElementById("cartItems");
            if(carrito.length === 0) {
                el.innerHTML = '<p style="color:#999; text-align:center;">Selecciona productos del men√∫</p>';
                document.getElementById("cartTotal").innerText = "$0.00";
                return;
            }

            el.innerHTML = carrito.map((i, idx) => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;">
                    <span>${i.nombre}</span>
                    <span>$${i.precio} <b style="color:red; cursor:pointer; margin-left:10px;" onclick="eliminarDelCarrito(${idx})">‚úï</b></span>
                </div>
            `).join('');
            
            const total = carrito.reduce((sum, i) => sum + parseInt(i.precio), 0);
            document.getElementById("cartTotal").innerText = `$${total.toFixed(2)}`;
        }

        function eliminarDelCarrito(idx) {
            carrito.splice(idx, 1);
            renderCarrito();
        }

        async function enviarPedido() {
            if(carrito.length === 0) return alert("Carrito vac√≠o");
            if(!currentMesa) return alert("Selecciona una mesa primero");
            
            try {
                await db.collection("comandas").add({
                    mesaId: currentMesa,
                    items: carrito,
                    estado: "pendiente",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                const mesaRef = await db.collection("mesas").where("id", "==", currentMesa).get();
                if(!mesaRef.empty) {
                    mesaRef.docs[0].ref.update({ estado: "ocupada" });
                }

                alert("¬°Pedido enviado a la Nube! ‚òÅÔ∏è");
                carrito = [];
                renderCarrito();
                verTab('mesas');

            } catch (error) {
                console.error(error);
                alert("Error al enviar: " + error.message);
            }
        }

        function cambiarEstado(docId, estado) {
            db.collection("comandas").doc(docId).update({ estado: estado });
            if(estado === 'cerrado') {
                 db.collection("comandas").doc(docId).get().then(doc => {
                     const data = doc.data();
                     db.collection("mesas").where("id", "==", data.mesaId).get().then(q => {
                         if(!q.empty) q.docs[0].ref.update({ estado: "libre" });
                     });
                 });
            }
        }

        // --- GESTI√ìN DE BASE DE DATOS (MEN√ö COMPLETO) ---

        // Funci√≥n para limpiar y recargar el men√∫ completo
        async function actualizarMenuCompleto() {
            if(!confirm("‚ö†Ô∏è ESTO BORRAR√Å EL MEN√ö ACTUAL y cargar√° el men√∫ completo de Las Brasas.\n¬øEst√°s seguro?")) return;
            
            const batch = db.batch();
            
            // 1. Borrar men√∫ existente (limitado a 500 ops por batch, pero para men√∫ peque√±o est√° bien)
            const snapshot = await db.collection("menu").get();
            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            // 2. Definir Men√∫ Completo (Extra√≠do de LasBrasas.html)
            const nuevoMenu = [
                // Tacos
                { nombre: "Taco Al Carb√≥n", precio: 40, categoria: "Tacos" },
                { nombre: "Taco Bistec", precio: 50, categoria: "Tacos" },
                { nombre: "Taco Cecina", precio: 50, categoria: "Tacos" },
                { nombre: "Taco Longaniza", precio: 40, categoria: "Tacos" },
                { nombre: "Taco Arrachera", precio: 60, categoria: "Tacos" },
                { nombre: "Taco Con Queso (Extra)", precio: 10, categoria: "Tacos" },
                // Gringas
                { nombre: "Gringa Normal", precio: 30, categoria: "Gringas" },
                { nombre: "Gringa Doble", precio: 55, categoria: "Gringas" },
                { nombre: "Gringa Champiqueso", precio: 30, categoria: "Gringas" },
                { nombre: "Gringa Choriqueso", precio: 30, categoria: "Gringas" },
                { nombre: "Megagringa", precio: 60, categoria: "Gringas" },
                { nombre: "Gringa Arrachera", precio: 35, categoria: "Gringas" },
                // Ensaladas
                { nombre: "Ensalada Sencilla", precio: 80, categoria: "Ensaladas" },
                { nombre: "Ensalada Carne al Carb√≥n", precio: 90, categoria: "Ensaladas" },
                { nombre: "Ensalada Bistec / Cecina", precio: 110, categoria: "Ensaladas" },
                { nombre: "Ensalada Arrachera", precio: 120, categoria: "Ensaladas" },
                { nombre: "Ensalada Pan Extra", precio: 15, categoria: "Ensaladas" },
                // Queso Fundido
                { nombre: "Queso Fundido Sencilla", precio: 90, categoria: "Queso Fundido" },
                { nombre: "Queso Fundido Bistec / Cecina", precio: 110, categoria: "Queso Fundido" },
                { nombre: "Queso Fundido Arrachera", precio: 120, categoria: "Queso Fundido" },
                // Extras
                { nombre: "Ord. Cebolla", precio: 15, categoria: "Extras" },
                { nombre: "Ord. Semilla", precio: 15, categoria: "Extras" },
                // Picaditas
                { nombre: "Picadita Sencilla", precio: 35, categoria: "Picaditas" },
                { nombre: "Picadita Carne al Carb√≥n", precio: 60, categoria: "Picaditas" },
                { nombre: "Picadita Cecina", precio: 70, categoria: "Picaditas" },
                { nombre: "Picadita Bistec", precio: 70, categoria: "Picaditas" },
                { nombre: "Picadita Longaniza", precio: 60, categoria: "Picaditas" },
                { nombre: "Picadita Arrachera", precio: 70, categoria: "Picaditas" },
                // Tortas
                { nombre: "Torta Al Carb√≥n", precio: 50, categoria: "Tortas" },
                { nombre: "Torta Bistec", precio: 60, categoria: "Tortas" },
                { nombre: "Torta Cecina", precio: 60, categoria: "Tortas" },
                { nombre: "Torta Arrachera", precio: 75, categoria: "Tortas" },
                { nombre: "Megatorta", precio: 70, categoria: "Tortas" },
                // Especiales
                { nombre: "Parrillada", precio: 95, categoria: "Especiales" },
                { nombre: "Alambre", precio: 95, categoria: "Especiales" },
                { nombre: "Fortach√≥n", precio: 100, categoria: "Especiales" },
                { nombre: "Pastor c/Queso", precio: 100, categoria: "Especiales" },
                { nombre: "Kilo de Carne", precio: 420, categoria: "Especiales" },
                // Volc√°n
                { nombre: "Volc√°n Carne al Carb√≥n (1 Pza)", precio: 18, categoria: "Volc√°n" },
                { nombre: "Volc√°n Bistec / Cecina (1 Pza)", precio: 21, categoria: "Volc√°n" },
                { nombre: "Volc√°n Arrachera", precio: 25, categoria: "Volc√°n" },
                // Bebidas
                { nombre: "Refresco", precio: 25, categoria: "Bebidas" },
                { nombre: "Refresco 600ml", precio: 30, categoria: "Bebidas" },
                { nombre: "Cerveza", precio: 40, categoria: "Bebidas" },
                { nombre: "Modelo Especial", precio: 45, categoria: "Bebidas" },
                { nombre: "Botella de Agua 1 Lt", precio: 20, categoria: "Bebidas" },
                { nombre: "Agua 1/2 Lt", precio: 18, categoria: "Bebidas" },
                { nombre: "Agua 1 Lt", precio: 30, categoria: "Bebidas" }
            ];

            nuevoMenu.forEach(item => {
                const ref = db.collection("menu").doc();
                batch.set(ref, item);
            });

            await batch.commit();
            alert("‚úÖ ¬°Men√∫ actualizado correctamente en la Nube!");
        }

        async function instalarBD() {
            // Esta funci√≥n instala lo b√°sico si est√° vac√≠o,
            // pero para el men√∫ completo usamos actualizarMenuCompleto()
            const batch = db.batch();
            
            // 1. Crear Mesas (1 a 10)
            for(let i=1; i<=10; i++) {
                const ref = db.collection("mesas").doc(); 
                batch.set(ref, { id: i, estado: "libre" });
            }
            await batch.commit();
            
            // Llamar a la funci√≥n del men√∫ completo
            await actualizarMenuCompleto();
            window.location.reload();
        }

        // --- UTILS ---
        function verTab(tabId) {
            document.getElementById('view-mesas').classList.add('hidden');
            document.getElementById('view-comanda').classList.add('hidden');
            document.getElementById('view-cocina').classList.add('hidden');
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const index = ['mesas', 'comanda', 'cocina'].indexOf(tabId);
            if(index >= 0) document.querySelectorAll('.tab')[index].classList.add('active');
        }

        function cambiarRol() {
            const rol = document.getElementById("rolSelect").value;
            if(rol === 'cocina') verTab('cocina');
            else if(rol === 'mesero') verTab('mesas');
            else if(rol === 'cliente') {
                modoCliente = true;
                const m = prompt("¬øN√∫mero de Mesa del Cliente?");
                if(m) {
                    currentMesa = parseInt(m);
                    document.getElementById('navTabs').style.display = 'none'; // Ocultar nav al cliente
                    abrirMesa(currentMesa);
                }
            }
        }

        function showQR(id) {
            document.getElementById("qrModal").style.display = 'flex';
            document.getElementById("qrcode").innerHTML = "";
            const url = window.location.href.split('?')[0] + "?mesa=" + id;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.get('mesa')) {
                document.getElementById('rolSelect').value = 'cliente';
                document.getElementById('navTabs').style.display = 'none';
                modoCliente = true;
                abrirMesa(parseInt(params.get('mesa')));
            }
        }
    </script>
</body>
</html>
