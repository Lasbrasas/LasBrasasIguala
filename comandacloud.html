<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Las Brasas POS v6.0 - CLOUD ‚òÅÔ∏è</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* ESTILOS BASE */
        :root { --primary: #d32f2f; --bg: #f4f6f9; --dark-bg: #121212; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding-bottom: 50px; }
        
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        
        /* TARJETAS */
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px; }
        
        .mesa { height: 100px; border-radius: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; cursor: pointer; position: relative; transition: 0.2s; }
        .mesa:hover { transform: scale(1.03); }
        .mesa.libre { background: #4caf50; }
        .mesa.ocupada { background: #d32f2f; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* BOTONES */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; margin-top: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #2e7d32; }
        .btn-warning { background: #ff9800; color: #333; }
        
        /* NAVEGACI√ìN */
        .tabs { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .tab { padding: 10px 15px; border: none; background: white; border-radius: 20px; cursor: pointer; white-space: nowrap; font-weight: 600; color: #555; }
        .tab.active { background: var(--primary); color: white; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        
        /* UI COCINA */
        .ticket-cocina { border-left: 6px solid #ccc; }
        .ticket-cocina.pendiente { border-color: #ff9800; background: #fff3e0; }
        .ticket-cocina.listo { border-color: #2e7d32; background: #e8f5e9; }
        .timer-badge { font-family: monospace; font-weight: bold; float: right; }
    </style>
</head>
<body>

    <div id="installer" class="modal">
        <div class="modal-content">
            <h1 style="font-size: 3em;">üöÄ</h1>
            <h2>Iniciando Sistema Cloud</h2>
            <p>Se detect√≥ una base de datos nueva.</p>
            <p>Haz clic para crear las Mesas y el Men√∫ inicial.</p>
            <button class="btn btn-primary" onclick="instalarBD()">üõ†Ô∏è INSTALAR BASE DE DATOS</button>
        </div>
    </div>

    <div id="qrModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Escanea Mesa <span id="qrMesaNum"></span></h3>
            <div id="qrcode" style="margin:20px auto; display:flex; justify-content:center"></div>
            <p style="font-size:0.8em; color:#666;">Comparte este c√≥digo para que el cliente pida desde su celular.</p>
            <button class="btn btn-warning" onclick="this.parentElement.parentElement.style.display='none'">Cerrar</button>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px;">
            <div>
                <h2 style="color:var(--primary); margin:0;">üî• Las Brasas</h2>
                <small style="color:green; font-weight:bold;">‚óè Conectado a la Nube</small>
            </div>
            <select id="rolSelect" onchange="cambiarRol()" style="padding:8px; border-radius:5px; border:1px solid #ddd;">
                <option value="mesero">Rol: Mesero</option>
                <option value="cocina">Rol: Cocina</option>
                <option value="cliente">Rol: Cliente (Simulado)</option>
            </select>
        </div>

        <div class="tabs" id="navTabs">
            <button class="tab active" onclick="verTab('mesas')">üìç Mesas</button>
            <button class="tab" onclick="verTab('comanda')">üìù Comanda</button>
            <button class="tab" onclick="verTab('cocina')">üî• Cocina Live</button>
        </div>

        <div id="view-mesas">
            <div class="grid" id="gridMesas">
                <p style="text-align:center; width:100%;">Cargando mesas desde Firebase...</p>
            </div>
        </div>

        <div id="view-comanda" class="hidden">
            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div class="card" style="border: 2px solid var(--primary);">
                    <h3 style="display:flex; justify-content:space-between;">
                        Mesa <span id="mesaTitle">--</span>
                        <span id="cartTotal" style="color:var(--primary); font-size:1.2em;">$0.00</span>
                    </h3>
                    <div id="cartItems" style="margin:10px 0; max-height:200px; overflow-y:auto; font-size:0.9em;">
                        <p style="color:#999; text-align:center;">Carrito vac√≠o</p>
                    </div>
                    <button class="btn btn-success" onclick="enviarPedido()">‚úÖ ENVIAR PEDIDO A COCINA</button>
                </div>
                
                <div>
                    <h3>Men√∫</h3>
                    <div class="grid" id="gridMenu">Cargando men√∫...</div>
                </div>
            </div>
        </div>

        <div id="view-cocina" class="hidden">
            <div id="cocinaList">Esperando √≥rdenes en tiempo real...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // üî¥ CONFIGURACI√ìN DE FIREBASE (INTEGRADA) üî¥
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB6LwVZmFSNVXvJgLF9nHy1Y3bkramhuEA",
            authDomain: "lasbrasaspos.firebaseapp.com",
            projectId: "lasbrasaspos",
            storageBucket: "lasbrasaspos.firebasestorage.app",
            messagingSenderId: "924369313118",
            appId: "1:924369313118:web:f124d313b1420f8dd983cf",
            measurementId: "G-LJC0KQJHEJ"
        };

        // INICIALIZAR FIREBASE
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // VARIABLES GLOBALES
        let currentMesa = null;
        let carrito = [];
        let modoCliente = false;

        // --- CORE: ESCUCHADORES EN TIEMPO REAL (MAGIC) ---

        // 1. Escuchar MESAS
        db.collection("mesas").orderBy("id").onSnapshot((snapshot) => {
            const el = document.getElementById("gridMesas");
            
            // Si no hay mesas, mostrar instalador
            if(snapshot.empty) {
                document.getElementById("installer").style.display = 'flex';
                el.innerHTML = "<p>Base de datos vac√≠a.</p>";
                return;
            } else {
                document.getElementById("installer").style.display = 'none';
            }

            el.innerHTML = "";
            snapshot.forEach((doc) => {
                const m = doc.data();
                const div = document.createElement("div");
                div.className = `mesa ${m.estado}`;
                div.innerHTML = `
                    <span style="font-size:2em">${m.id}</span>
                    <small>${m.estado.toUpperCase()}</small>
                    ${!modoCliente ? `<span style="position:absolute; bottom:5px; right:5px; font-size:1.2em;">üì±</span>` : ''}
                `;
                div.onclick = () => {
                    if(!modoCliente) showQR(m.id);
                    abrirMesa(m.id); 
                };
                el.appendChild(div);
            });
        });

        // 2. Escuchar MEN√ö
        db.collection("menu").orderBy("nombre").onSnapshot((snapshot) => {
            const el = document.getElementById("gridMenu");
            el.innerHTML = "";
            snapshot.forEach((doc) => {
                const p = doc.data();
                const btn = document.createElement("div");
                btn.className = "card";
                btn.style.cursor = "pointer";
                btn.innerHTML = `<b>${p.nombre}</b><br><span style="color:var(--primary)">$${p.precio}</span>`;
                btn.onclick = () => agregarAlCarrito(p);
                el.appendChild(btn);
            });
        });

        // 3. Escuchar COMANDAS (Cocina)
        db.collection("comandas")
          .where("estado", "!=", "cerrado")
          .orderBy("estado", "desc") // Mostrar pendientes primero (requiere indice, si falla usaremos js sort)
          .onSnapshot((snapshot) => {
            const el = document.getElementById("cocinaList");
            el.innerHTML = "";
            if(snapshot.empty) el.innerHTML = "<p style='text-align:center; margin-top:50px;'>Todo limpio, Chef üë®‚Äçüç≥</p>";

            snapshot.forEach((doc) => {
                const c = doc.data();
                const card = document.createElement("div");
                card.className = `card ticket-cocina ${c.estado}`;
                
                // Calcular tiempo
                let tiempo = "Ahora";
                if(c.timestamp) {
                    const diff = Math.floor((Date.now() - c.timestamp.toDate()) / 1000 / 60);
                    tiempo = `${diff} min`;
                }

                let btnAccion = "";
                if(c.estado === 'pendiente') btnAccion = `<button class="btn btn-primary" onclick="cambiarEstado('${doc.id}', 'listo')">üî• A Fuego</button>`;
                if(c.estado === 'listo') btnAccion = `<button class="btn btn-success" onclick="cambiarEstado('${doc.id}', 'cerrado')">‚úÖ Entregar y Cerrar</button>`;

                card.innerHTML = `
                    <h3>Mesa ${c.mesaId} <span class="timer-badge">${tiempo}</span></h3>
                    <small>Estado: ${c.estado.toUpperCase()}</small>
                    <hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">
                    <ul style="padding-left:20px; margin:10px 0;">
                        ${c.items.map(i => `<li>${i.nombre}</li>`).join('')}
                    </ul>
                    ${btnAccion}
                `;
                el.appendChild(card);
            });
        }, (error) => {
            // Fallback si falta el √≠ndice compuesto en Firebase
            console.log("Esperando √≠ndice...", error);
            // Reintentar sin ordenar por estado para que funcione al inicio
            db.collection("comandas").where("estado", "!=", "cerrado").onSnapshot(snap => {
                 const el = document.getElementById("cocinaList");
                 el.innerHTML = "";
                 snap.forEach(doc => { /* L√≥gica de render repetida... */ });
            });
        });

        // --- L√ìGICA DE NEGOCIO ---

        function abrirMesa(id) {
            currentMesa = id;
            document.getElementById("mesaTitle").innerText = id;
            carrito = [];
            renderCarrito();
            verTab('comanda');
        }

        function agregarAlCarrito(prod) {
            carrito.push(prod);
            renderCarrito();
        }

        function renderCarrito() {
            const el = document.getElementById("cartItems");
            if(carrito.length === 0) {
                el.innerHTML = '<p style="color:#999; text-align:center;">Selecciona productos del men√∫</p>';
                document.getElementById("cartTotal").innerText = "$0.00";
                return;
            }

            el.innerHTML = carrito.map((i, idx) => `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px;">
                    <span>${i.nombre}</span>
                    <span>$${i.precio} <b style="color:red; cursor:pointer; margin-left:10px;" onclick="eliminarDelCarrito(${idx})">‚úï</b></span>
                </div>
            `).join('');
            
            const total = carrito.reduce((sum, i) => sum + parseInt(i.precio), 0);
            document.getElementById("cartTotal").innerText = `$${total.toFixed(2)}`;
        }

        function eliminarDelCarrito(idx) {
            carrito.splice(idx, 1);
            renderCarrito();
        }

        async function enviarPedido() {
            if(carrito.length === 0) return alert("Carrito vac√≠o");
            if(!currentMesa) return alert("Selecciona una mesa primero");
            
            try {
                // 1. Guardar Comanda
                await db.collection("comandas").add({
                    mesaId: currentMesa,
                    items: carrito,
                    estado: "pendiente",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Actualizar estado Mesa (buscamos por ID l√≥gico 'id' no docId para simplificar, 
                // pero lo ideal es actualizar el doc correspondiente).
                // En este script simplificado, la UI de mesa se actualiza sola al recibir cambios,
                // pero debemos escribir el estado en la BD.
                
                // Buscar el documento de la mesa y actualizarlo
                const q = await db.collection("mesas").where("id", "==", currentMesa).get();
                if(!q.empty) {
                    q.docs[0].ref.update({ estado: "ocupada" });
                }

                alert("¬°Pedido enviado a la Nube! ‚òÅÔ∏è");
                carrito = [];
                renderCarrito();
                verTab('mesas');

            } catch (error) {
                console.error(error);
                alert("Error al enviar: " + error.message);
            }
        }

        function cambiarEstado(docId, estado) {
            db.collection("comandas").doc(docId).update({ estado: estado });
            // Si se cierra, liberar mesa
            if(estado === 'cerrado') {
                 // Recuperar mesaId de la comanda para liberar mesa
                 db.collection("comandas").doc(docId).get().then(doc => {
                     const data = doc.data();
                     db.collection("mesas").where("id", "==", data.mesaId).get().then(q => {
                         if(!q.empty) q.docs[0].ref.update({ estado: "libre" });
                     });
                 });
            }
        }

        // --- INSTALADOR AUTOM√ÅTICO ---
        async function instalarBD() {
            const batch = db.batch();
            
            // 1. Crear Mesas (1 a 10)
            for(let i=1; i<=10; i++) {
                // Usamos el ID del documento igual al numero para facilitar
                const ref = db.collection("mesas").doc(); 
                batch.set(ref, { id: i, estado: "libre" });
            }

            // 2. Crear Men√∫ Inicial
            const menu = [
                { nombre: "Tacos Pastor", precio: 25 },
                { nombre: "Arrachera", precio: 60 },
                { nombre: "Gringa", precio: 45 },
                { nombre: "Refresco", precio: 20 },
                { nombre: "Cerveza", precio: 35 }
            ];
            
            menu.forEach(item => {
                const ref = db.collection("menu").doc();
                batch.set(ref, item);
            });

            await batch.commit();
            alert("¬°Instalaci√≥n Completa! El sistema se reiniciar√°.");
            window.location.reload();
        }

        // --- UTILS ---
        function verTab(tabId) {
            document.getElementById('view-mesas').classList.add('hidden');
            document.getElementById('view-comanda').classList.add('hidden');
            document.getElementById('view-cocina').classList.add('hidden');
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const index = ['mesas', 'comanda', 'cocina'].indexOf(tabId);
            if(index >= 0) document.querySelectorAll('.tab')[index].classList.add('active');
        }

        function cambiarRol() {
            const rol = document.getElementById("rolSelect").value;
            if(rol === 'cocina') verTab('cocina');
            else if(rol === 'mesero') verTab('mesas');
            else if(rol === 'cliente') {
                modoCliente = true;
                const m = prompt("¬øN√∫mero de Mesa del Cliente?");
                if(m) {
                    currentMesa = parseInt(m);
                    document.getElementById('navTabs').style.display = 'none'; // Ocultar nav al cliente
                    abrirMesa(currentMesa);
                }
            }
        }

        function showQR(id) {
            document.getElementById("qrModal").style.display = 'flex';
            document.getElementById("qrcode").innerHTML = "";
            const url = window.location.href.split('?')[0] + "?mesa=" + id;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
            document.getElementById("qrLink").innerText = url;
        }

        // Auto-login cliente por URL
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.get('mesa')) {
                document.getElementById('rolSelect').value = 'cliente';
                document.getElementById('navTabs').style.display = 'none';
                modoCliente = true;
                abrirMesa(parseInt(params.get('mesa')));
            }
        }
    </script>
</body>
</html>
