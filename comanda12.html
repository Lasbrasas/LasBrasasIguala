<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Las Brasas POS v12.0 - CRM & Facturaci√≥n</title>
    <meta name="theme-color" content="#d32f2f">
    
    <!-- Librer√≠as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS VISUALES PREMIUM --- */
        :root { 
            --primary: #d32f2f; 
            --primary-dark: #b71c1c;
            --accent: #ffc107;
            --bg: #f4f6f9; 
            --text-main: #222;
            --text-soft: #555;
            --success: #2e7d32;
            --danger: #c62828;
            --blue: #1976d2;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        
        /* APP HEADER */
        .app-header {
            background: white;
            padding: 12px 16px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .brand-title { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .badge-cloud { font-size: 0.75rem; padding: 4px 10px; border-radius: 99px; background: rgba(46, 125, 50, 0.1); color: var(--success); font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: inline-block; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* GRID SISTEMA */
        .grid { display: grid; gap: 12px; }
        .grid-mesas { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .grid-menu { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        
        /* TARJETAS */
        .card { 
            background: white; 
            padding: 16px; 
            border-radius: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.15s ease;
        }
        
        /* BOTONES */
        .btn { 
            padding: 10px 18px; 
            border: none; 
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex; justify-content: center; align-items: center; gap: 6px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--accent); color: #333; }
        .btn-info { background: var(--blue); color: white; }
        .btn-dark { background: #343a40; color: white; }
        .btn-ghost { background: #f5f5f5; color: var(--text-soft); }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: var(--text-main); }
        .btn-outline.selected { border-color: var(--primary); color: var(--primary); background: #fff5f5; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        /* TABS DE NAVEGACI√ìN */
        .tabs { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; scrollbar-width: none; }
        .tab { 
            padding: 10px 20px; 
            border: none; 
            background: white; 
            border-radius: 99px; 
            cursor: pointer; 
            white-space: nowrap; 
            font-weight: 600; 
            color: var(--text-soft); 
            border: 1px solid #eee;
            transition: all 0.2s;
        }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(211, 47, 47, 0.25); transform: translateY(-1px); }

        /* CATEGORY PILLS */
        .cat-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .cat-pill { padding: 8px 16px; border-radius: 20px; background: #fff; border: 1px solid #ddd; color: #555; cursor: pointer; font-weight: 600; white-space: nowrap; transition: 0.2s; }
        .cat-pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 8px rgba(211,47,47,0.3); }

        /* MESAS */
        .mesa { 
            height: 100px; 
            border-radius: 16px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            font-weight: 800; 
            cursor: pointer; 
            position: relative; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .mesa:active { transform: scale(0.95); }
        .mesa.libre { background: linear-gradient(135deg, #66bb6a, #43a047); }
        .mesa.ocupada { background: linear-gradient(135deg, #ef5350, #c62828); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 83, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 83, 80, 0); } }

        /* PRODUCTO CARD */
        .product-card {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border-left: 5px solid transparent;
            padding: 15px;
        }
        .product-name { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .product-price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .product-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-soft); margin-bottom: 4px; }
        
        .stock-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase; }
        .stock-normal { background: #e8f5e9; color: var(--success); }
        .stock-low { background: #fff3cd; color: #f57f17; }
        .stock-out { background: #ffebee; color: var(--danger); }
        .item-disabled { opacity: 0.6; filter: grayscale(1); pointer-events: none; }

        /* COCINA TICKET */
        .ticket-cocina { border-left: 6px solid #ccc; position: relative; }
        .ticket-cocina.pendiente { border-color: var(--accent); background: #fff8e1; }
        .ticket-cocina.listo { border-color: var(--success); background: #e8f5e9; }
        .timer-badge { font-family: monospace; font-weight: bold; font-size: 0.9rem; padding: 4px 8px; background: rgba(0,0,0,0.05); border-radius: 6px; float: right; }

        /* INPUTS CRM */
        .input-crm { width:100%; padding:12px; margin-bottom:12px; border:1px solid #ddd; border-radius:10px; font-size:1rem; outline: none; transition: border 0.2s; }
        .input-crm:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1); }
        .input-label { display: block; font-size: 0.85rem; color: var(--text-soft); margin-bottom: 4px; font-weight: 600; }

        /* MODALES */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* CARRITO */
        .cart-item { padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; }
        .cart-item-mods { font-size: 0.8rem; color: var(--text-soft); margin-top: 4px; font-style: italic; }

        /* IMPRESI√ìN */
        @media print {
            body * { visibility: hidden; }
            #ticket-print, #ticket-print * { visibility: visible; }
            #ticket-print { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            @page { margin: 0; size: 80mm auto; }
        }
        #ticket-print { display: none; width: 80mm; background: white; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; color: black; }
        .ticket-line { border-bottom: 1px dashed #000; margin: 5px 0; }
    </style>
</head>
<body>

    <!-- SONIDO -->
    <audio id="audio-bell" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- TICKET INVISIBLE -->
    <div id="ticket-print" style="display:none;"></div>

    <!-- MODAL PRODUCTO (MODIFICADORES) -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <h3 id="modProdName" style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom:10px;">Producto</h3>
            <p style="color:#666; font-size:0.9em; margin-bottom:15px;">Stock: <span id="modProdStock" style="font-weight:bold;">--</span></p>
            
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-outline" onclick="toggleOption(this, 'Con Todo')">Con Todo</button>
                <button class="btn btn-outline" onclick="toggleOption(this, 'Sin Cebolla')">üö´ Cebolla</button>
                <button class="btn btn-outline" onclick="toggleOption(this, 'Sin Cilantro')">üö´ Cilantro</button>
                <button class="btn btn-outline" onclick="toggleOption(this, 'Sin Pi√±a')">üö´ Pi√±a</button>
                <button class="btn btn-outline" onclick="toggleOption(this, 'Salsa Aparte')">üå∂Ô∏è Salsa Aparte</button>
                <button class="btn btn-outline" onclick="toggleOption(this, 'Bien Dorado')">üî• Bien Dorado</button>
            </div>
            <input type="text" id="modNota" class="input-crm" placeholder="Nota extra...">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-ghost" style="flex:1" onclick="document.getElementById('modalProducto').style.display='none'">Cancelar</button>
                <button class="btn btn-primary" style="flex:1" onclick="confirmarAgregarProducto()">Agregar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO MANUAL -->
    <div id="modalManual" class="modal">
        <div class="modal-content">
            <h3>‚ûï Manual / Extra</h3>
            <input type="text" id="manNombre" placeholder="Descripci√≥n" class="input-crm">
            <input type="number" id="manPrecio" placeholder="Precio ($)" class="input-crm">
            <button class="btn btn-success" style="width:100%" onclick="confirmarManual()">Agregar</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="document.getElementById('modalManual').style.display='none'">Cancelar</button>
        </div>
    </div>

    <!-- MODAL PIN -->
    <div id="modalPin" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h3>üîê Seguridad</h3>
            <input type="password" id="pinInput" style="font-size:2em; letter-spacing:10px; width:150px; text-align:center; padding:10px; border:2px solid #ddd; border-radius:12px; margin:20px auto;" maxlength="4">
            <button class="btn btn-dark" style="width:100%" onclick="verificarPin()">Acceder</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="cerrarModalPin()">Cancelar</button>
        </div>
    </div>

    <!-- MODAL CRM COMPLETO (FACTURACI√ìN) -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-bottom:15px;">üë§ Gesti√≥n de Cliente</h3>
            
            <!-- Buscador -->
            <div style="display:flex; gap:10px; margin-bottom:20px; background:#f5f5f5; padding:10px; border-radius:10px;">
                <input type="tel" id="crmTelefono" placeholder="Ingresa Tel√©fono (10 d√≠gitos)" class="input-crm" style="margin:0;">
                <button class="btn btn-info" style="width:auto;" onclick="buscarCliente()">üîç</button>
            </div>

            <div id="crmTabs" class="cat-scroll" style="margin-bottom:15px;">
                <button class="cat-pill active" onclick="verTabCrm('datos')">üè† Env√≠o / Contacto</button>
                <button class="cat-pill" onclick="verTabCrm('factura')">üßæ Datos Facturaci√≥n</button>
            </div>

            <!-- Tab Datos B√°sicos -->
            <div id="crm-datos">
                <span class="input-label">Nombre Completo</span>
                <input type="text" id="clienteNombre" placeholder="Ej. Juan P√©rez" class="input-crm">
                <span class="input-label">Direcci√≥n de Entrega</span>
                <input type="text" id="clienteDireccion" placeholder="Calle, N√∫mero, Colonia, Referencias" class="input-crm">
            </div>

            <!-- Tab Facturaci√≥n -->
            <div id="crm-factura" class="hidden">
                <span class="input-label">Raz√≥n Social / Nombre Fiscal</span>
                <input type="text" id="facturaRazon" placeholder="Nombre en Constancia" class="input-crm">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <span class="input-label">RFC</span>
                        <input type="text" id="facturaRFC" placeholder="ABCD123456XYZ" class="input-crm" style="text-transform:uppercase;">
                    </div>
                    <div>
                        <span class="input-label">C.P. Fiscal</span>
                        <input type="number" id="facturaCP" placeholder="40000" class="input-crm">
                    </div>
                </div>
                <span class="input-label">R√©gimen Fiscal</span>
                <select id="facturaRegimen" class="input-crm">
                    <option value="">Seleccione...</option>
                    <option value="601">General de Ley Personas Morales</option>
                    <option value="612">Personas F√≠sicas con Actividades Empresariales</option>
                    <option value="626">R√©gimen Simplificado de Confianza</option>
                    <option value="603">Personas Morales con Fines no Lucrativos</option>
                    <option value="605">Sueldos y Salarios e Ingresos Asimilados a Salarios</option>
                    <option value="606">Arrendamiento</option>
                    <option value="608">Dem√°s ingresos</option>
                    <option value="611">Ingresos por Dividendos (socios y accionistas)</option>
                    <option value="614">Ingresos por intereses</option>
                    <option value="616">Sin obligaciones fiscales</option>
                    <option value="621">Incorporaci√≥n Fiscal</option>
                    <option value="622">Actividades Agr√≠colas, Ganaderas, Silv√≠colas y Pesqueras</option>
                    <option value="629">De los Reg√≠menes Fiscales Preferentes y de las Empresas Multinacionales</option>
                    <option value="630">Enajenaci√≥n de acciones en bolsa de valores</option>
                </select>
                <span class="input-label">Correo para Factura</span>
                <input type="email" id="facturaEmail" placeholder="cliente@email.com" class="input-crm">
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" style="flex:1" onclick="document.getElementById('modalCliente').style.display='none'">Cancelar</button>
                <button class="btn btn-success" style="flex:1" onclick="confirmarDatosCliente()">Guardar y Usar</button>
            </div>
        </div>
    </div>

    <!-- MODAL QR -->
    <div id="qrModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" style="text-align:center;" onclick="event.stopPropagation()">
            <h3>Mesa <span id="qrMesaNum"></span></h3>
            <div id="qrcode" style="margin:20px auto; display:flex; justify-content:center"></div>
            <button class="btn btn-ghost" onclick="this.parentElement.parentElement.style.display='none'">Cerrar</button>
        </div>
    </div>

    <!-- MODAL EDICI√ìN PRODUCTO (ADMIN) -->
    <div id="modalEditProd" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Editar Producto</h3>
            <input type="hidden" id="editProdId">
            <span class="input-label">Nombre</span>
            <input type="text" id="editProdName" class="input-crm">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <span class="input-label">Precio</span>
                    <input type="number" id="editProdPrice" class="input-crm">
                </div>
                <div>
                    <span class="input-label">Stock</span>
                    <input type="number" id="editProdStock" class="input-crm">
                </div>
            </div>
            <span class="input-label">Categor√≠a</span>
            <input type="text" id="editProdCat" class="input-crm">
            
            <button class="btn btn-success" style="width:100%" onclick="guardarEdicionProducto()">Guardar Cambios</button>
            <button class="btn btn-warning" style="width:100%; margin-top:10px;" onclick="eliminarProducto()">üóëÔ∏è Eliminar Producto</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="document.getElementById('modalEditProd').style.display='none'">Cancelar</button>
        </div>
    </div>

    <!-- APP SHELL -->
    <div class="container">
        <!-- HEADER -->
        <div id="appHeader" class="app-header">
            <div class="brand-title">üî• Las Brasas <small style="font-size:0.5em; color:#999; margin-left:5px;">v12.0</small></div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <span class="badge-cloud"><span class="dot"></span> Online</span>
                <select id="rolSelect" onchange="solicitarCambioRol()" style="padding:8px 12px; border-radius:10px; border:1px solid #ddd; font-weight:bold; cursor:pointer;">
                    <option value="mesero">üë§ Mesero</option>
                    <option value="cocina">üë®‚Äçüç≥ Cocina</option>
                    <option value="caja">üí∞ Caja üîí</option>
                    <option value="admin">‚öôÔ∏è Admin üîí</option>
                    <option value="cliente">üì± Cliente</option>
                </select>
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs" id="navTabs">
            <button class="tab active" onclick="verTab('mesas')">üìç Piso</button>
            <button class="tab" onclick="verTab('comanda')">üìù Pedido</button>
            <button class="tab" onclick="verTab('cocina')">üî• Cocina</button>
            <button class="tab" onclick="verTab('caja')">üí∞ Caja</button>
            <button class="tab" onclick="verTab('admin')">üìä Admin</button>
        </div>

        <!-- VISTA: MESAS -->
        <div id="view-mesas">
            <div id="mesasControls" style="margin-bottom: 20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-primary" style="background:#e83e8c; border:none;" onclick="iniciarOrdenExterna('llevar')">üõçÔ∏è Para Llevar</button>
                <button class="btn btn-warning" style="background:#fd7e14; color:white; border:none;" onclick="iniciarOrdenExterna('domicilio')">üõµ Domicilio</button>
            </div>
            <h4 style="margin-bottom:15px; color:var(--text-soft);">COMEDOR</h4>
            <div class="grid grid-mesas" id="gridMesas"><p style="text-align:center;">Cargando...</p></div>
        </div>

        <!-- VISTA: COMANDA -->
        <div id="view-comanda" class="hidden">
            <div class="grid" style="grid-template-columns: 1fr; gap: 20px;">
                <!-- Panel Pedido -->
                <div class="card" style="border: 2px solid var(--primary); position: sticky; top: 10px; z-index: 10;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div>
                            <h3 style="margin:0; font-size:1.2rem;" id="pedidoTitulo">--</h3>
                            <small id="pedidoDetalle" style="color:#666; font-style:italic; font-size:0.85rem;"></small>
                        </div>
                        <span id="cartTotal" style="color:var(--primary); font-weight:800; font-size:1.3rem;">$0.00</span>
                    </div>
                    
                    <!-- Bot√≥n CRM en el carrito -->
                    <button class="btn btn-info btn-sm" style="width:100%; margin-bottom:10px;" onclick="abrirModalCliente()">üë§ Asignar Cliente / Factura</button>

                    <div id="cartItems" style="margin:10px 0; max-height:250px; overflow-y:auto; background:#f8f9fa; padding:10px; border-radius:10px; min-height:60px;">
                        <p style="color:#999; text-align:center; font-size:0.9rem; padding-top:15px;">Carrito vac√≠o</p>
                    </div>
                    <button class="btn btn-success" style="width:100%; padding:15px;" onclick="enviarPedido()">‚úÖ CONFIRMAR PEDIDO</button>
                </div>
                
                <!-- Men√∫ con Filtros -->
                <div>
                    <div class="cat-scroll" id="catFilters"></div> <!-- Categor√≠as -->
                    <div style="display:flex; gap:10px; margin-bottom: 15px;">
                        <input type="text" id="menuSearch" placeholder="üîç Buscar..." onkeyup="filtrarMenu()" style="flex:1; padding: 12px; border: 1px solid #ddd; border-radius: 10px;">
                        <button class="btn btn-dark" style="width:auto; margin:0;" onclick="document.getElementById('modalManual').style.display='flex'">‚ûï</button>
                    </div>
                    <div class="grid grid-menu" id="gridMenu"></div>
                </div>
            </div>
        </div>

        <!-- VISTA: COCINA -->
        <div id="view-cocina" class="hidden">
            <div id="cocinaList" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));"></div>
        </div>

        <!-- VISTA: CAJA -->
        <div id="view-caja" class="hidden">
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:20px;">
                <div class="card" style="background:#e3f2fd; border: 1px solid #bbdefb;">
                    <h3 style="color:#1565c0; margin-bottom:15px;">üí∞ Por Cobrar</h3>
                    <div id="listaPorCobrar"></div>
                </div>
                <div class="card" style="background:#fff3e0; border: 1px solid #ffe0b2;">
                    <h3 style="color:#e65100; margin-bottom:15px;">üöÄ Despacho / Env√≠os</h3>
                    <div id="listaSalidas"></div>
                </div>
            </div>
        </div>

        <!-- VISTA: ADMIN (NUEVA SUITE) -->
        <div id="view-admin" class="hidden">
            
            <!-- Sub-Navegaci√≥n Admin -->
            <div class="cat-scroll">
                <button class="cat-pill active" onclick="verSubTabAdmin('stats')">üìä Estad√≠sticas</button>
                <button class="cat-pill" onclick="verSubTabAdmin('menu')">üçî Editar Men√∫</button>
                <button class="cat-pill" onclick="verSubTabAdmin('crm')">üë• Clientes</button>
                <button class="cat-pill" onclick="verSubTabAdmin('config')">‚öôÔ∏è Config</button>
            </div>

            <!-- 1. Estad√≠sticas (Corte Z) -->
            <div id="admin-stats">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <h2>Corte de Caja</h2>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-outline" style="border-color:var(--danger); color:var(--danger); font-size:0.8em;" onclick="abrirModalMerma()">üóëÔ∏è Registrar Merma</button>
                            <button class="btn btn-dark btn-sm" onclick="generarCorte()">Refrescar</button>
                        </div>
                    </div>
                    <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom:20px;">
                        <div style="text-align:center;">
                            <small>Venta Total</small>
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--success);" id="corteTotal">$0.00</div>
                        </div>
                        <div style="text-align:center;">
                            <small>√ìrdenes</small>
                            <div style="font-size:1.5rem; font-weight:bold;" id="corteCount">0</div>
                        </div>
                        <div style="text-align:center;">
                            <small>Mermas</small>
                            <div style="font-size:1.5rem; font-weight:bold; color:var(--danger);" id="corteMermas">$0.00</div>
                        </div>
                    </div>
                    <canvas id="salesChart" height="200"></canvas>
                </div>
            </div>

            <!-- 2. Editor de Men√∫ -->
            <div id="admin-menu" class="hidden">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                        <h3>Cat√°logo de Productos</h3>
                        <button class="btn btn-success btn-sm" onclick="actualizarMenuCompleto()">Restaurar Default</button>
                    </div>
                    <input type="text" id="adminMenuSearch" placeholder="Buscar para editar..." onkeyup="filtrarAdminMenu()" class="input-crm">
                    <div style="max-height:400px; overflow-y:auto;">
                        <table class="admin-table">
                            <thead><tr><th>Producto</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead>
                            <tbody id="adminMenuTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. CRM -->
            <div id="admin-crm" class="hidden">
                <div class="card">
                    <h3>Base de Datos Clientes</h3>
                    <div style="max-height:400px; overflow-y:auto;">
                        <table class="admin-table" id="crmTable">
                            <thead><tr><th>Nombre</th><th>Tel√©fono</th><th>RFC</th></tr></thead>
                            <tbody><tr><td colspan="3">Cargando...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. Config -->
            <div id="admin-config" class="hidden">
                <div class="card">
                    <h3>Configuraci√≥n General</h3>
                    <label>Total de Mesas:</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="configMesas" value="10" class="input-crm">
                        <button class="btn btn-primary" onclick="reconfigurarMesas()">Aplicar</button>
                    </div>
                    <p style="color:#666; font-size:0.8rem;">‚ö†Ô∏è Cambiar el n√∫mero de mesas reiniciar√° su estado a "Libre".</p>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL MERMAS (OCULTO EN HTML PERO USADO EN JS) -->
    <div id="modalMerma" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--danger);">üóëÔ∏è Registrar Merma</h3>
            <p style="color:#666; font-size:0.9em; margin-bottom:20px;">Descuenta stock sin venta.</p>
            <label style="font-size:0.9em; font-weight:bold;">Producto:</label>
            <select id="mermaProducto" class="input-crm" style="background:white;"></select>
            <label style="font-size:0.9em; font-weight:bold;">Cantidad:</label>
            <input type="number" id="mermaCantidad" value="1" min="1" class="input-crm">
            <label style="font-size:0.9em; font-weight:bold;">Raz√≥n:</label>
            <select id="mermaRazon" class="input-crm" style="background:white;">
                <option>Caducado</option>
                <option>Se cay√≥ / Accidente</option>
                <option>Error de Cocina</option>
                <option>Degustaci√≥n</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-ghost" style="flex:1" onclick="document.getElementById('modalMerma').style.display='none'">Cancelar</button>
                <button class="btn btn-primary" style="flex:1; background:var(--danger);" onclick="confirmarMerma()">Registrar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB6LwVZmFSNVXvJgLF9nHy1Y3bkramhuEA",
            authDomain: "lasbrasaspos.firebaseapp.com",
            projectId: "lasbrasaspos",
            storageBucket: "lasbrasaspos.firebasestorage.app",
            messagingSenderId: "924369313118",
            appId: "1:924369313118:web:f124d313b1420f8dd983cf",
            measurementId: "G-LJC0KQJHEJ"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ESTADO ---
        let currentOrden = { tipo: 'mesa', id: null, cliente: {} };
        let carrito = [];
        let menuCache = [];
        let pendingRole = null;
        let itemSeleccionado = null; 
        let audioEnabled = false;
        let modoCliente = false; 
        let activeCategory = 'Todos';

        document.addEventListener('click', () => { audioEnabled = true; }, { once: true });

        // --- REALTIME LISTENERS ---

        // 1. MESAS
        db.collection("mesas").orderBy("id").onSnapshot((snapshot) => {
            const el = document.getElementById("gridMesas");
            el.innerHTML = "";
            snapshot.forEach((doc) => {
                const m = doc.data();
                const div = document.createElement("div");
                div.className = `mesa ${m.estado}`;
                div.innerHTML = `<span style="font-size:2em">${m.id}</span><small>${m.estado.toUpperCase()}</small>`;
                if (!modoCliente) {
                    div.innerHTML += `<span style="position:absolute; top:5px; right:5px; font-size:1.2em; opacity:0.8;" onclick="event.stopPropagation(); showQR(${m.id})">üì±</span>`;
                }
                div.onclick = () => iniciarOrdenMesa(m.id);
                el.appendChild(div);
            });
        });

        // 2. MEN√ö (Con Stock)
        db.collection("menu").orderBy("nombre").onSnapshot((snapshot) => {
            menuCache = [];
            let categorias = new Set(['Todos']);
            snapshot.forEach(doc => {
                const data = doc.data();
                menuCache.push({ id: doc.id, ...data });
                if(data.categoria) categorias.add(data.categoria);
            });
            renderCategories(Array.from(categorias));
            renderMenuGrid();
            renderAdminMenuTable();
        });

        // 3. COMANDAS
        db.collection("comandas").where("estado", "!=", "cerrado").onSnapshot((snapshot) => {
            renderCocina(snapshot);
            renderCaja(snapshot);
            snapshot.docChanges().forEach(change => {
                if (change.type === "added" && change.doc.data().estado === 'pendiente') {
                    if(audioEnabled) document.getElementById('audio-bell').play().catch(e=>console.log(e));
                }
            });
        });

        // --- RENDERIZADO ---

        function renderCategories(cats) {
            const el = document.getElementById('catFilters');
            el.innerHTML = cats.map(c => 
                `<button class="cat-pill ${c === activeCategory ? 'active' : ''}" onclick="selectCategory('${c}')">${c}</button>`
            ).join('');
        }

        function selectCategory(cat) {
            activeCategory = cat;
            renderCategories(Array.from(new Set(['Todos', ...menuCache.map(p=>p.categoria)]))); 
            renderMenuGrid();
        }

        function renderMenuGrid() {
            const el = document.getElementById("gridMenu");
            el.innerHTML = "";
            const term = document.getElementById("menuSearch").value.toLowerCase();
            
            const filtered = menuCache.filter(p => {
                const matchText = p.nombre.toLowerCase().includes(term);
                const matchCat = activeCategory === 'Todos' || p.categoria === activeCategory;
                return matchText && matchCat;
            });

            if(filtered.length === 0) {
                el.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#999; padding:20px;">Sin resultados</p>`;
                return;
            }

            filtered.forEach((p) => {
                const stock = p.stock !== undefined ? p.stock : 100;
                const agotado = stock <= 0;
                
                const btn = document.createElement("div");
                btn.className = `card product-card ${agotado ? 'item-disabled' : ''}`;
                btn.style.cursor = "pointer";
                btn.style.borderLeftColor = getColorCat(p.categoria);
                
                let stockClass = stock < 10 ? 'stock-low' : 'stock-normal';
                if(agotado) stockClass = 'stock-out';

                btn.innerHTML = `
                    <div class="product-meta">
                        <span>${p.categoria || 'Gral'}</span>
                        <span class="stock-badge ${stockClass}">${agotado ? 'AGOTADO' : stock}</span>
                    </div>
                    <div class="product-name">${p.nombre}</div>
                    <div class="product-price">$${p.precio}</div>
                `;
                btn.onclick = () => abrirModalProducto(p);
                el.appendChild(btn);
            });
        }

        function renderCocina(snapshot) {
            const el = document.getElementById("cocinaList");
            el.innerHTML = "";
            let docs = [];
            snapshot.forEach(doc => docs.push({ id: doc.id, ...doc.data() }));
            docs.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            if(docs.length === 0) el.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#999; padding:40px;'>Todo limpio, Chef üë®‚Äçüç≥</p>";

            docs.forEach(c => {
                if(c.estado === 'enviado' || c.estado === 'entregado') return;
                const card = document.createElement("div");
                card.className = `card ticket-cocina ${c.estado}`;
                
                let icono = c.tipo === 'mesa' ? 'üçΩÔ∏è' : (c.tipo === 'llevar' ? 'üõçÔ∏è' : 'üõµ');
                let titulo = c.tipo === 'mesa' ? 'Mesa '+c.mesaId : (c.cliente ? c.cliente.nombre : 'Sin Nombre');
                let tiempo = getTiempo(c.timestamp);

                let btn = "";
                if(c.estado === 'pendiente') btn = `<button class="btn btn-primary btn-sm" onclick="cambiarEstado('${c.id}', 'listo')">üî• A Fuego</button>`;
                else if(c.estado === 'listo') btn = `<button class="btn btn-success btn-sm" onclick="cambiarEstado('${c.id}', 'despacho')">‚úÖ Terminar</button>`;

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0;">${icono} ${titulo}</h3>
                        <span class="timer-badge">${tiempo}</span>
                    </div>
                    ${c.cliente && c.cliente.direccion ? `<small style="color:#666;">üìç ${c.cliente.direccion}</small>` : ''}
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #ddd;">
                    <ul style="padding-left:20px; margin:10px 0; font-size:0.95rem;">
                        ${c.items.map(i => `<li><b>${i.cantidad || 1}</b> ${i.nombre} ${i.notas && i.notas.length ? `<br><small style="background:#fff3cd;">‚ö†Ô∏è ${i.notas.join(',')}</small>` : ''}</li>`).join('')}
                    </ul>
                    ${btn}
                `;
                el.appendChild(card);
            });
        }

        function renderCaja(snapshot) {
            const listaCobrar = document.getElementById("listaPorCobrar");
            const listaSalidas = document.getElementById("listaSalidas");
            listaCobrar.innerHTML = "";
            listaSalidas.innerHTML = "";

            snapshot.forEach(doc => {
                const c = doc.data();
                const total = c.items.reduce((sum, i) => sum + i.precio, 0);
                let clienteNombre = c.cliente ? c.cliente.nombre : 'Cliente';
                
                const div = document.createElement("div");
                div.style.borderBottom = "1px solid #ddd";
                div.style.padding = "10px 0";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <b>${c.tipo === 'mesa' ? 'Mesa '+c.mesaId : clienteNombre}</b>
                        <b style="color:var(--primary)">$${total}</b>
                    </div>
                    <small style="color:#666;">${c.estado.toUpperCase()} ‚Ä¢ ${c.items.length} items</small>
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button class="btn btn-dark btn-sm" style="width:auto;" onclick="imprimirTicket('${doc.id}')">üñ®Ô∏è</button>
                        ${c.estado !== 'cerrado' ? `<button class="btn btn-success btn-sm" style="flex:1;" onclick="cambiarEstado('${doc.id}', 'cerrado')">üí∞ Cobrar</button>` : ''}
                    </div>
                `;
                listaCobrar.appendChild(div);

                if ((c.tipo === 'domicilio' || c.tipo === 'llevar') && c.estado !== 'pendiente') {
                    const divSalida = document.createElement("div");
                    divSalida.style.borderBottom = "1px solid #ddd";
                    divSalida.style.padding = "10px 0";
                    let dir = c.cliente ? c.cliente.direccion : 'Para Llevar';
                    
                    let btnSalida = "";
                    if(c.estado === 'despacho' || c.estado === 'listo') btnSalida = `<button class="btn btn-warning btn-sm" style="width:100%;" onclick="cambiarEstado('${doc.id}', 'enviado')">üõµ Enviar</button>`;
                    else if(c.estado === 'enviado') btnSalida = `<button class="btn btn-success btn-sm" style="width:100%;" onclick="cambiarEstado('${doc.id}', 'entregado')">‚úÖ Entregado</button>`;
                    else btnSalida = `<span style="color:var(--success); font-weight:bold; font-size:0.8rem;">Completado</span>`;

                    divSalida.innerHTML = `<b>${clienteNombre}</b><br><small>${dir}</small><div style="margin-top:5px;">${btnSalida}</div>`;
                    listaSalidas.appendChild(divSalida);
                }
            });
        }

        // --- CRM (CLIENTES & FACTURACI√ìN) ---
        function verTabCrm(tab) {
            document.getElementById('crm-datos').classList.add('hidden');
            document.getElementById('crm-factura').classList.add('hidden');
            document.getElementById('crm-'+tab).classList.remove('hidden');
            
            document.querySelectorAll('#crmTabs .cat-pill').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function buscarCliente() {
            const tel = document.getElementById("crmTelefono").value;
            if(!tel || tel.length < 10) return alert("Ingresa un n√∫mero de 10 d√≠gitos");
            
            const q = await db.collection("clientes").where("telefono", "==", tel).get();
            const campos = document.getElementById("crmCampos");
            campos.style.opacity = "1";
            campos.style.pointerEvents = "auto";

            if(!q.empty) {
                const c = q.docs[0].data();
                document.getElementById("clienteNombre").value = c.nombre || '';
                document.getElementById("clienteDireccion").value = c.direccion || '';
                // Facturaci√≥n
                document.getElementById("facturaRazon").value = c.facturacion?.razonSocial || '';
                document.getElementById("facturaRFC").value = c.facturacion?.rfc || '';
                document.getElementById("facturaCP").value = c.facturacion?.cp || '';
                document.getElementById("facturaEmail").value = c.facturacion?.email || '';
                document.getElementById("facturaRegimen").value = c.facturacion?.regimen || '';
            } else {
                // Nuevo
                document.getElementById("clienteNombre").value = "";
                document.getElementById("clienteDireccion").value = "";
                document.getElementById("facturaRazon").value = "";
                document.getElementById("facturaRFC").value = "";
                document.getElementById("facturaCP").value = "";
                document.getElementById("facturaEmail").value = "";
            }
        }

        async function confirmarDatosCliente() {
            const tel = document.getElementById("crmTelefono").value;
            const nombre = document.getElementById("clienteNombre").value;
            const direccion = document.getElementById("clienteDireccion").value;
            
            if(!tel || !nombre) return alert("Tel√©fono y Nombre son obligatorios");

            const clienteData = {
                telefono: tel,
                nombre: nombre,
                direccion: direccion,
                ultimaCompra: new Date(),
                facturacion: {
                    razonSocial: document.getElementById("facturaRazon").value,
                    rfc: document.getElementById("facturaRFC").value,
                    cp: document.getElementById("facturaCP").value,
                    email: document.getElementById("facturaEmail").value,
                    regimen: document.getElementById("facturaRegimen").value
                }
            };

            // Guardar/Actualizar en Firebase
            const q = await db.collection("clientes").where("telefono", "==", tel).get();
            if(q.empty) {
                await db.collection("clientes").add(clienteData);
            } else {
                await q.docs[0].ref.update(clienteData);
            }

            // Asignar a la orden actual
            currentOrden.cliente = clienteData;
            
            // Actualizar UI
            document.getElementById('modalEnvio').style.display = 'none'; // OLD modal remove
            document.getElementById('modalCliente').style.display = 'none';
            actualizarHeaderPedido();
            
            // Si ven√≠a de "Domicilio", ir directo a comanda
            if(currentOrden.tipo === 'domicilio' || currentOrden.tipo === 'llevar') {
                verTab('comanda');
            }
        }

        // --- ADMIN FUNCIONES ---
        function verSubTabAdmin(subTab) {
            document.getElementById('admin-stats').classList.add('hidden');
            document.getElementById('admin-menu').classList.add('hidden');
            document.getElementById('admin-crm').classList.add('hidden');
            document.getElementById('admin-config').classList.add('hidden');
            
            document.getElementById(`admin-${subTab}`).classList.remove('hidden');
            
            if(subTab === 'crm') cargarCRM();
            if(subTab === 'stats') generarCorte(); 
        }

        function renderAdminMenuTable() {
            const el = document.getElementById("adminMenuTable");
            const term = document.getElementById("adminMenuSearch").value.toLowerCase();
            el.innerHTML = menuCache.filter(p => p.nombre.toLowerCase().includes(term)).map(p => `
                <tr>
                    <td><b>${p.nombre}</b><br><small>${p.categoria}</small></td>
                    <td>$${p.precio}</td>
                    <td>${p.stock}</td>
                    <td><button class="btn btn-info btn-sm" onclick='editarProducto(${JSON.stringify(p)})'>‚úèÔ∏è</button></td>
                </tr>
            `).join('');
        }

        function filtrarAdminMenu() { renderAdminMenuTable(); }

        function editarProducto(p) {
            document.getElementById('editProdId').value = p.id;
            document.getElementById('editProdName').value = p.nombre;
            document.getElementById('editProdPrice').value = p.precio;
            document.getElementById('editProdStock').value = p.stock;
            document.getElementById('editProdCat').value = p.categoria;
            document.getElementById('modalEditProd').style.display = 'flex';
        }

        async function guardarEdicionProducto() {
            const id = document.getElementById('editProdId').value;
            const data = {
                nombre: document.getElementById('editProdName').value,
                precio: parseFloat(document.getElementById('editProdPrice').value),
                stock: parseInt(document.getElementById('editProdStock').value),
                categoria: document.getElementById('editProdCat').value
            };
            await db.collection("menu").doc(id).update(data);
            document.getElementById('modalEditProd').style.display = 'none';
            alert("Producto actualizado");
        }

        async function eliminarProducto() {
            if(!confirm("¬øBorrar este producto?")) return;
            const id = document.getElementById('editProdId').value;
            await db.collection("menu").doc(id).delete();
            document.getElementById('modalEditProd').style.display = 'none';
        }

        async function cargarCRM() {
            const tbody = document.querySelector("#crmTable tbody");
            tbody.innerHTML = "<tr><td colspan='3'>Cargando...</td></tr>";
            const snap = await db.collection("clientes").orderBy("ultimaCompra", "desc").limit(50).get();
            tbody.innerHTML = "";
            snap.forEach(doc => {
                const c = doc.data();
                tbody.innerHTML += `<tr><td>${c.nombre}</td><td>${c.telefono}</td><td>${c.facturacion?.rfc || '-'}</td></tr>`;
            });
        }

        async function reconfigurarMesas() {
            const num = parseInt(document.getElementById("configMesas").value);
            if(!confirm(`¬øResetear todo a ${num} mesas?`)) return;
            
            const batch = db.batch();
            const snap = await db.collection("mesas").get();
            snap.forEach(d => batch.delete(d.ref));
            
            for(let i=1; i<=num; i++) {
                const ref = db.collection("mesas").doc();
                batch.set(ref, { id: i, estado: "libre" });
            }
            await batch.commit();
            alert("Mesas reconfiguradas");
        }

        // --- CORE LOGIC (PEDIDOS, ETC) ---
        
        function iniciarOrdenMesa(id) {
            currentOrden = { tipo: 'mesa', id: id, cliente: {} };
            actualizarHeaderPedido();
            carrito = [];
            renderCarrito();
            verTab('comanda');
        }

        function iniciarOrdenExterna(tipo) {
            currentOrden = { tipo: tipo, id: null, cliente: {} };
            // Abrir Modal CRM Nuevo
            document.getElementById("crmTelefono").value = "";
            document.getElementById("clienteNombre").value = "";
            document.getElementById("clienteDireccion").value = "";
            document.getElementById('modalCliente').style.display = 'flex';
        }

        function abrirModalCliente() {
            document.getElementById('modalCliente').style.display = 'flex';
        }

        function actualizarHeaderPedido() {
            let titulo = '--';
            let detalle = '';
            
            if(currentOrden.tipo === 'mesa') {
                titulo = `üçΩÔ∏è Mesa ${currentOrden.id}`;
            } else {
                titulo = currentOrden.tipo === 'llevar' ? 'üõçÔ∏è Para Llevar' : 'üõµ Domicilio';
                detalle = currentOrden.cliente.nombre || 'Sin cliente asignado';
            }
            
            document.getElementById('pedidoTitulo').innerText = titulo;
            document.getElementById('pedidoDetalle').innerText = detalle;
        }

        function abrirModalProducto(prod) {
            itemSeleccionado = { ...prod, notas: [] }; 
            document.getElementById('modProdName').innerText = prod.nombre;
            const stock = prod.stock !== undefined ? prod.stock : '‚àû';
            document.getElementById('modProdStock').innerText = stock;
            document.getElementById('modNota').value = '';
            document.querySelectorAll('.btn-outline.selected').forEach(b => b.classList.remove('selected'));
            document.getElementById('modalProducto').style.display = 'flex';
        }

        function toggleOption(btn, texto) {
            btn.classList.toggle('selected');
            if(btn.classList.contains('selected')) itemSeleccionado.notas.push(texto);
            else itemSeleccionado.notas = itemSeleccionado.notas.filter(n => n !== texto);
        }

        function cerrarModalProducto() { document.getElementById('modalProducto').style.display = 'none'; }

        function confirmarAgregarProducto() {
            const notaExtra = document.getElementById('modNota').value;
            if(notaExtra) itemSeleccionado.notas.push(notaExtra);
            carrito.push(itemSeleccionado);
            renderCarrito();
            cerrarModalProducto();
        }

        function confirmarManual() {
            const n = document.getElementById('manNombre').value;
            const p = parseFloat(document.getElementById('manPrecio').value);
            if(!n || isNaN(p)) return alert("Datos inv√°lidos");
            carrito.push({ nombre: n, precio: p, categoria: 'Manual', notas: ['Manual'], isManual: true, id: 'man_' + Date.now() });
            renderCarrito();
            document.getElementById('modalManual').style.display = 'none';
            document.getElementById('manNombre').value = '';
            document.getElementById('manPrecio').value = '';
        }

        function renderCarrito() {
            const el = document.getElementById("cartItems");
            if(carrito.length === 0) {
                el.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">Carrito vac√≠o</p>';
                document.getElementById("cartTotal").innerText = "$0.00";
                return;
            }
            el.innerHTML = carrito.map((i, idx) => `
                <div class="cart-item">
                    <div style="display:flex; justify-content:space-between; font-weight:600;">
                        <span>${i.nombre}</span>
                        <span>$${i.precio} <span style="color:#c62828; cursor:pointer; margin-left:8px;" onclick="carrito.splice(${idx},1);renderCarrito()">‚úï</span></span>
                    </div>
                    ${i.notas.length > 0 ? `<div class="cart-item-mods">+ ${i.notas.join(', ')}</div>` : ''}
                </div>
            `).join('');
            const total = carrito.reduce((sum, i) => sum + parseInt(i.precio), 0);
            document.getElementById("cartTotal").innerText = `$${total.toFixed(2)}`;
        }

        async function enviarPedido() {
            if(carrito.length === 0) return alert("Carrito vac√≠o");
            
            // Validar cliente en pedidos a domicilio
            if(currentOrden.tipo !== 'mesa' && !currentOrden.cliente.nombre) {
                alert("Debes asignar un cliente para pedidos a domicilio/llevar");
                abrirModalCliente();
                return;
            }

            try {
                const batch = db.batch();
                let conteos = {};
                carrito.forEach(i => { if(i.id && !i.isManual) conteos[i.id] = (conteos[i.id] || 0) + 1; });

                for (const [id, qty] of Object.entries(conteos)) {
                    const ref = db.collection('menu').doc(id);
                    batch.update(ref, { stock: firebase.firestore.FieldValue.increment(-qty) });
                }

                const comandaRef = db.collection("comandas").doc();
                batch.set(comandaRef, {
                    tipo: currentOrden.tipo,
                    mesaId: currentOrden.tipo === 'mesa' ? currentOrden.id : null,
                    cliente: currentOrden.cliente || {}, // Guardar objeto completo cliente
                    clienteNombre: currentOrden.cliente.nombre || 'Mesa',
                    clienteDireccion: currentOrden.cliente.direccion || '',
                    items: carrito,
                    estado: "pendiente",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                if(currentOrden.tipo === 'mesa') {
                    const mesaQuery = await db.collection("mesas").where("id", "==", currentOrden.id).get();
                    if(!mesaQuery.empty) batch.update(mesaQuery.docs[0].ref, { estado: "ocupada" });
                }

                await batch.commit();
                alert("‚úÖ Pedido enviado");
                carrito = [];
                renderCarrito();
                if(currentOrden.tipo === 'mesa') verTab('mesas'); else verTab('caja');

            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function generarCorte() {
            const hoy = new Date(); hoy.setHours(0,0,0,0);
            const ventasSnap = await db.collection("comandas").where("estado", "==", "cerrado").get();
            let total = 0, count = 0, categorias = {};
            // Array para la gr√°fica
            let labels = [], dataPoints = [];

            ventasSnap.forEach(doc => {
                const data = doc.data();
                if(data.timestamp && data.timestamp.toDate() >= hoy) {
                    count++;
                    data.items.forEach(i => {
                        total += i.precio;
                        const cat = i.categoria || 'Otros';
                        categorias[cat] = (categorias[cat] || 0) + i.precio;
                    });
                }
            });

            // Mermas
            const mermasSnap = await db.collection("mermas").get();
            let totalMermas = 0;
            mermasSnap.forEach(doc => {
                const data = doc.data();
                if(data.fecha && data.fecha.toDate() >= hoy) totalMermas += (data.costoEstimado || 0);
            });

            document.getElementById("corteTotal").innerText = `$${total.toFixed(2)}`;
            document.getElementById("corteCount").innerText = count;
            document.getElementById("corteMermas").innerText = `$${totalMermas.toFixed(2)}`;

            // Render Gr√°fica
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        label: 'Ventas por Categor√≠a',
                        data: Object.values(categorias),
                        backgroundColor: '#d32f2f'
                    }]
                }
            });
        }

        function cambiarEstado(docId, estado) {
            db.collection("comandas").doc(docId).update({ estado: estado });
            if(estado === 'cerrado') {
                db.collection("comandas").doc(docId).get().then(doc => {
                    const d = doc.data();
                    if(d.tipo === 'mesa') {
                        db.collection("mesas").where("id", "==", d.mesaId).get()
                          .then(q => { if(!q.empty) q.docs[0].ref.update({ estado: "libre" }); });
                    }
                });
            }
        }

        function solicitarCambioRol() {
            const nuevoRol = document.getElementById("rolSelect").value;
            if(nuevoRol === 'caja' || nuevoRol === 'admin') {
                pendingRole = nuevoRol;
                document.getElementById("rolSelect").value = 'mesero'; 
                document.getElementById("modalPin").style.display = 'flex';
                document.getElementById("pinInput").value = '';
                document.getElementById("pinInput").focus();
            } else if (nuevoRol === 'cliente') {
                activarModoCliente();
            } else {
                aplicarRol(nuevoRol);
            }
        }

        function verificarPin() {
            if(document.getElementById("pinInput").value === '1234') { 
                aplicarRol(pendingRole);
                document.getElementById("rolSelect").value = pendingRole;
                cerrarModalPin();
            } else alert("PIN Incorrecto");
        }

        function aplicarRol(rol) {
            verTab(rol === 'cocina' ? 'cocina' : (rol === 'caja' ? 'caja' : (rol === 'admin' ? 'admin' : 'mesas')));
        }

        function cerrarModalPin() { document.getElementById("modalPin").style.display = 'none'; }

        function verTab(id) {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabMap = { 'mesas':0, 'comanda':1, 'cocina':2, 'caja':3, 'admin':4 };
            if(tabMap[id] !== undefined) document.querySelectorAll('.tab')[tabMap[id]].classList.add('active');
        }

        function getTiempo(timestamp) {
            if(!timestamp) return 'Now';
            const diff = Math.floor((Date.now() - timestamp.toDate()) / 1000 / 60);
            return diff + ' min';
        }

        function getColorCat(cat) {
            if(cat === 'Tacos') return '#d32f2f';
            if(cat === 'Bebidas') return '#1976d2';
            return '#ff9800';
        }

        function filtrarMenu() {
            const t = document.getElementById("menuSearch").value.toLowerCase();
            renderMenuGrid(menuCache.filter(p => p.nombre.toLowerCase().includes(t)));
        }

        // --- MERMAS (ADMIN) ---
        function abrirModalMerma() {
            const sel = document.getElementById("mermaProducto");
            sel.innerHTML = menuCache.map(p => `<option value="${p.id}">${p.nombre} (Stock: ${p.stock})</option>`).join('');
            document.getElementById("modalMerma").style.display = 'flex';
        }

        async function confirmarMerma() {
            const prodId = document.getElementById("mermaProducto").value;
            const cantidad = parseInt(document.getElementById("mermaCantidad").value);
            const razon = document.getElementById("mermaRazon").value;
            const prod = menuCache.find(p => p.id === prodId);
            if(cantidad <= 0) return alert("Cantidad inv√°lida");

            const batch = db.batch();
            const prodRef = db.collection("menu").doc(prodId);
            batch.update(prodRef, { stock: firebase.firestore.FieldValue.increment(-cantidad) });
            const mermaRef = db.collection("mermas").doc();
            batch.set(mermaRef, { producto: prod.nombre, cantidad: cantidad, costoEstimado: prod.precio * cantidad, razon: razon, fecha: firebase.firestore.FieldValue.serverTimestamp() });

            await batch.commit();
            alert("üóëÔ∏è Merma registrada");
            document.getElementById("modalMerma").style.display = 'none';
        }

        async function imprimirTicket(docId) {
            const doc = await db.collection("comandas").doc(docId).get();
            const d = doc.data();
            const total = d.items.reduce((acc, i) => acc + i.precio, 0);
            const itemsHtml = d.items.map(i => `<div class="ticket-item"><span>${i.cantidad || 1} ${i.nombre}</span><span>$${i.precio}</span></div>`).join('');
            
            // Datos Facturaci√≥n si existen
            let datosFiscales = '';
            if(d.cliente && d.cliente.facturacion && d.cliente.facturacion.rfc) {
                datosFiscales = `<div style="margin-top:10px; font-size:10px; border-top:1px solid #000;">
                    <b>DATOS FACTURACI√ìN:</b><br>
                    RFC: ${d.cliente.facturacion.rfc}<br>
                    Nombre: ${d.cliente.facturacion.razonSocial}<br>
                    CP: ${d.cliente.facturacion.cp}<br>
                    R√©gimen: ${d.cliente.facturacion.regimen}<br>
                </div>`;
            }

            document.getElementById('ticket-print').innerHTML = `
                <div class="ticket-header">
                    <h3>LAS BRASAS</h3><p>Folio: ${doc.id.slice(-4).toUpperCase()}</p><div class="ticket-line"></div>
                    <p>${d.tipo.toUpperCase()}: ${d.clienteNombre || d.mesaId}</p>
                </div>
                <div>${itemsHtml}</div>
                <div class="ticket-line"></div>
                <div class="ticket-total">TOTAL: $${total}</div>
                ${datosFiscales}
            `;
            window.print();
        }

        async function actualizarMenuCompleto() {
            if(!confirm("‚ö†Ô∏è Cargar men√∫ completo?")) return;
            const batch = db.batch();
            const snap = await db.collection("menu").get();
            snap.forEach(d => batch.delete(d.ref));

            // MEN√ö COMPLETO DEFINITIVO
            const nuevoMenu = [
                // Tacos
                { nombre: "Taco Al Carb√≥n", precio: 40, categoria: "Tacos", stock: 100 },
                { nombre: "Taco Bistec", precio: 50, categoria: "Tacos", stock: 100 },
                { nombre: "Taco Cecina", precio: 50, categoria: "Tacos", stock: 100 },
                { nombre: "Taco Longaniza", precio: 40, categoria: "Tacos", stock: 100 },
                { nombre: "Taco Arrachera", precio: 60, categoria: "Tacos", stock: 100 },
                { nombre: "Taco Con Queso (Extra)", precio: 10, categoria: "Tacos", stock: 100 },
                // Gringas
                { nombre: "Gringa Normal", precio: 30, categoria: "Gringas", stock: 50 },
                { nombre: "Gringa Doble", precio: 55, categoria: "Gringas", stock: 50 },
                { nombre: "Champiqueso", precio: 30, categoria: "Gringas", stock: 50 },
                { nombre: "Choriqueso", precio: 30, categoria: "Gringas", stock: 50 },
                { nombre: "Megagringa", precio: 60, categoria: "Gringas", stock: 50 },
                { nombre: "Gringa Arrachera", precio: 35, categoria: "Gringas", stock: 50 },
                // Ensaladas
                { nombre: "Ensalada Sencilla", precio: 80, categoria: "Ensaladas", stock: 30 },
                { nombre: "Ensalada Carne al Carb√≥n", precio: 90, categoria: "Ensaladas", stock: 30 },
                { nombre: "Ensalada Bistec/Cecina", precio: 110, categoria: "Ensaladas", stock: 30 },
                { nombre: "Ensalada Arrachera", precio: 120, categoria: "Ensaladas", stock: 30 },
                { nombre: "Ensalada Pan Extra", precio: 15, categoria: "Ensaladas", stock: 50 },
                // Queso Fundido
                { nombre: "Queso Sencillo", precio: 90, categoria: "Queso Fundido", stock: 40 },
                { nombre: "Queso Bistec/Cecina", precio: 110, categoria: "Queso Fundido", stock: 40 },
                { nombre: "Queso Arrachera", precio: 120, categoria: "Queso Fundido", stock: 40 },
                // Extras
                { nombre: "Orden Cebolla", precio: 15, categoria: "Extras", stock: 100 },
                { nombre: "Orden Semilla", precio: 15, categoria: "Extras", stock: 100 },
                // Picaditas
                { nombre: "Picadita Sencilla", precio: 35, categoria: "Picaditas", stock: 50 },
                { nombre: "Picadita Carb√≥n", precio: 60, categoria: "Picaditas", stock: 50 },
                { nombre: "Picadita Cecina", precio: 70, categoria: "Picaditas", stock: 50 },
                { nombre: "Picadita Bistec", precio: 70, categoria: "Picaditas", stock: 50 },
                { nombre: "Picadita Longaniza", precio: 60, categoria: "Picaditas", stock: 50 },
                { nombre: "Picadita Arrachera", precio: 70, categoria: "Picaditas", stock: 50 },
                // Tortas
                { nombre: "Torta Al Carb√≥n", precio: 50, categoria: "Tortas", stock: 60 },
                { nombre: "Torta Bistec", precio: 60, categoria: "Tortas", stock: 60 },
                { nombre: "Torta Cecina", precio: 60, categoria: "Tortas", stock: 60 },
                { nombre: "Torta Arrachera", precio: 75, categoria: "Tortas", stock: 60 },
                { nombre: "Megatorta", precio: 70, categoria: "Tortas", stock: 60 },
                // Especiales
                { nombre: "Parrillada", precio: 95, categoria: "Especiales", stock: 20 },
                { nombre: "Alambre", precio: 95, categoria: "Especiales", stock: 20 },
                { nombre: "Fortach√≥n", precio: 100, categoria: "Especiales", stock: 20 },
                { nombre: "Pastor c/Queso", precio: 100, categoria: "Especiales", stock: 20 },
                { nombre: "Kilo de Carne", precio: 420, categoria: "Especiales", stock: 10 },
                // Volc√°n
                { nombre: "Volc√°n Carb√≥n (1 Pza)", precio: 18, categoria: "Volc√°n", stock: 50 },
                { nombre: "Volc√°n Bistec / Cecina (1 Pza)", precio: 21, categoria: "Volc√°n", stock: 50 },
                { nombre: "Volc√°n Arrachera", precio: 25, categoria: "Volc√°n", stock: 50 },
                // Bebidas
                { nombre: "Refresco", precio: 25, categoria: "Bebidas", stock: 200 },
                { nombre: "Refresco 600ml", precio: 30, categoria: "Bebidas", stock: 200 },
                { nombre: "Cerveza", precio: 40, categoria: "Bebidas", stock: 200 },
                { nombre: "Modelo Especial", precio: 45, categoria: "Bebidas", stock: 200 },
                { nombre: "Botella de Agua 1 Lt", precio: 20, categoria: "Bebidas", stock: 200 },
                { nombre: "Agua 1/2 Lt", precio: 18, categoria: "Bebidas", stock: 200 },
                { nombre: "Agua 1 Lt", precio: 30, categoria: "Bebidas", stock: 200 }
            ];
            nuevoMenu.forEach(i => batch.set(db.collection("menu").doc(), i));
            await batch.commit();
            alert("‚úÖ Men√∫ Actualizado");
        }

        function showQR(id) {
            document.getElementById("qrModal").style.display = 'flex';
            document.getElementById("qrcode").innerHTML = "";
            const url = window.location.href.split('?')[0] + "?mesa=" + id + "&mode=cliente";
            new QRCode(document.getElementById("qrcode"), { text: url, width: 200, height: 200 });
        }

        function activarModoCliente() {
            modoCliente = true;
            document.getElementById('rolSelect').style.display = 'none';
            document.getElementById('btnUpdateMenu').style.display = 'none';
            document.getElementById('navTabs').style.display = 'none';
            document.getElementById('mesasControls').style.display = 'none';
            document.querySelector('.badge-cloud').innerHTML = "üëã Bienvenido";
            verTab('mesas');
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.get('mesa') && params.get('mode') === 'cliente') {
                activarModoCliente();
                iniciarOrdenMesa(parseInt(params.get('mesa')));
            }
        }
    </script>
</body>
</html>
